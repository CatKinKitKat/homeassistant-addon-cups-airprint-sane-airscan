#!/bin/bash
#
# CUPS AirPrint & SANE AirScan Unified Add-on for Home Assistant
# SANE Configuration Script
# Copyright (C) 2025 CatKinKitKat
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.

set -e

# Get configuration options from Home Assistant
ALLOWED_NETWORKS=$(bashio::config 'allowed_networks')

bashio::log.info "Configuring minimalist SANE setup..."

# Configure saned.conf
bashio::log.info "Configuring saned.conf..."
cat > /etc/sane.d/saned.conf << EOF
# saned.conf - Auto-generated minimalist configuration

## Access list
# Allowed networks for scanning access
EOF

# Add allowed networks
for network in $(echo "${ALLOWED_NETWORKS}" | jq -r '.[]'); do
    echo "${network}" >> /etc/sane.d/saned.conf
done

# Configure net.conf for network scanning
bashio::log.info "Configuring net.conf..."
cat > /etc/sane.d/net.conf << EOF
# net backend config file - Auto-generated
localhost
EOF

# Configure dll.conf with auto-detection and optimal backends
bashio::log.info "Configuring dll.conf with optimal brand-specific backends..."
cat > /etc/sane.d/dll.conf << EOF
# dll.conf - Optimized auto-detection configuration for major scanner brands

# Network backends (always enabled)
net
airscan

# Core auto-detection
usb
test

# OPTIMAL BACKENDS BY BRAND:

# Canon - PIXMA backend is best for most Canon scanners
pixma
canon
canon_dr
canon630u

# Epson - epson2 is newer and better than old epson backend  
epson2
epson
epsonds

# HP - hp backend (Note: hpaio from HPLIP not available in Alpine)
hp
hpljm1005
hp3500
hp3900
hp4200
hp5400
hp5590

# Brother - brother backend family
brother
brother3
brother4

# Fujitsu - fujitsu backend for fi-series and ScanSnap
fujitsu

# Kodak - kodak backend for flatbeds + ADF
kodak
kodakaio

# Plustek - plustek backend for USB models
plustek
plustek_pp

# UMAX - umax backend for legacy devices
umax
umax1220u
umax_pp

# Lexmark - lexmark backend for older AIOs
lexmark

# Ricoh - uses fujitsu backend (Ricoh ADFs are rebadged Fujitsu)
ricoh
ricoh2

# Sharp - sharp backend for niche models
sharp

# Additional common backends for comprehensive auto-detection
genesys
gt68xx
microtek
microtek2
mustek
mustek_usb
mustek_usb2
snapscan
ma1509
matsushita
pie
sm3840
teco1
teco2
teco3
u12
EOF

# Configure airscan.conf for network scanner discovery
bashio::log.info "Configuring AirScan for network scanner discovery..."
cat > /etc/sane.d/airscan.conf << EOF
# airscan.conf - Auto-generated configuration for network scanner discovery

[devices]
# Manually configured devices can be added here
# Example: "Scanner Name" = http://192.168.1.100:9095/eSCL

[options]
# Enable automatic discovery (default)
discovery = enable

# Use network device name for display (more user-friendly)
model = network

# Auto-select best protocol (eSCL vs WSD)
protocol = auto

# Use fast WS-Discovery mode (default)
ws-discovery = fast

# Treat remote scanners as local (helps with saned sharing)
pretend-local = true

[debug]
# Basic logging enabled
enable = true

[blacklist]
# No devices blacklisted by default
EOF

# Set proper permissions
chown -R root:root /etc/sane.d/
chmod 644 /etc/sane.d/*.conf

# Create lock directory
mkdir -p /var/lock/sane
chmod 755 /var/lock/sane

bashio::log.info "SANE minimalist configuration completed"
bashio::log.info "Optimal backends enabled by brand:"
bashio::log.info "  Canon: pixma (best for PIXMA/MFPs)"
bashio::log.info "  Epson: epson2 (newer, better than old epson)"
bashio::log.info "  HP: hp (Note: hpaio from HPLIP not available in Alpine)"
bashio::log.info "  Brother: brother (may need proprietary drivers for some models)"
bashio::log.info "  Fujitsu: fujitsu (fi-series, ScanSnap support)"
bashio::log.info "  Kodak: kodak (flatbeds + ADF scanners)"
bashio::log.info "  Plustek: plustek (USB models)"
bashio::log.info "  UMAX: umax (legacy devices)"
bashio::log.info "  Lexmark: lexmark (older AIOs)"
bashio::log.info "  Ricoh: fujitsu (Ricoh ADFs are rebadged Fujitsu)"
bashio::log.info "  Sharp: sharp (niche models)"
bashio::log.info "Auto-detection enabled for USB and network scanners"
bashio::log.info "AirScan configured for network scanner discovery"
